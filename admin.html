<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة القيادة | Pro Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --sidebar-width: 260px; 
            --header-height: 70px; 
            --primary: #006847; 
            --dark: #111827; 
            --light: #f3f4f6;
        }
        body { font-family: 'Tajawal', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* 1. Sidebar (20%) */
        .sidebar { width: var(--sidebar-width); background: var(--dark); color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; }
        .brand { height: var(--header-height); display: flex; align-items: center; padding: 0 25px; font-size: 20px; font-weight: 900; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand span { color: var(--primary); margin-right: 5px; }
        
        .menu { padding: 20px; flex: 1; }
        .menu-item { padding: 15px 20px; margin-bottom: 8px; border-radius: 12px; cursor: pointer; color: #9ca3af; font-weight: 500; display: flex; align-items: center; gap: 15px; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: white; transform: translateX(-5px); }

        /* 2. Main Content (80%) */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: var(--header-height); background: white; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .page-content { padding: 30px; overflow-y: auto; height: 100%; }

        /* Components */
        .card-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .stat-card h3 { margin: 0; font-size: 32px; color: var(--dark); }
        .stat-card p { margin: 5px 0 0; color: #6b7280; font-size: 14px; }
        .stat-card::after { content:''; position: absolute; right: 0; top:0; height: 100%; width: 5px; background: var(--primary); }

        table { width: 100%; background: white; border-radius: 16px; border-collapse: collapse; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        th { text-align: right; padding: 18px; background: #f9fafb; font-size: 12px; color: #6b7280; font-weight: 800; text-transform: uppercase; }
        td { padding: 18px; border-bottom: 1px solid #f3f4f6; font-size: 14px; font-weight: 600; }
        
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; }
        .pending { background: #fff7ed; color: #c2410c; }
        .confirmed { background: #f0fdf4; color: #15803d; }

        /* Login Screen */
        #loginOverlay { position: fixed; inset: 0; background: var(--dark); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; width: 400px; padding: 40px; border-radius: 24px; text-align: center; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #f3f4f6; border-radius: 12px; font-family: inherit; outline: none; box-sizing: border-box; }
        .login-input:focus { border-color: var(--primary); }
        .login-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }

        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="margin:0 0 10px 0; color:var(--dark);">بوابة الإدارة</h2>
        <p style="color:#6b7280; margin-bottom:30px;">تسديدة محترف - لوحة التحكم</p>
        <input type="password" id="adminPass" class="login-input" placeholder="كلمة المرور">
        <button class="login-btn" onclick="login()">تسجيل الدخول</button>
    </div>
</div>

<div class="sidebar">
    <div class="brand">تسديدة <span>محترف</span></div>
    <div class="menu">
        <div class="menu-item active" onclick="switchView('dash', this)"><i class="fas fa-home"></i> الرئيسية</div>
        <div class="menu-item" onclick="switchView('bookings', this)"><i class="fas fa-calendar-check"></i> الحجوزات</div>
        <div class="menu-item" onclick="switchView('finance', this)"><i class="fas fa-chart-pie"></i> المالية</div>
        <div class="menu-item" onclick="switchView('settings', this)"><i class="fas fa-cog"></i> الإعدادات</div>
    </div>
</div>

<div class="main-content">
    <div class="top-bar">
        <div style="font-weight:bold; font-size:18px;">لوحة القيادة</div>
        <div><i class="fas fa-bell" style="color:#9ca3af; cursor:pointer;"></i></div>
    </div>

    <div class="page-content">
        
        <div id="dash" class="view-section active">
            <div class="card-grid">
                <div class="stat-card">
                    <h3 id="dashIncome">0 ريال</h3>
                    <p>إجمالي الدخل</p>
                </div>
                <div class="stat-card" style="border-right-color:#f59e0b;">
                    <h3 id="dashPending">0</h3>
                    <p>طلبات قيد الانتظار</p>
                </div>
                <div class="stat-card" style="border-right-color:#3b82f6;">
                    <h3 id="dashTotal">0</h3>
                    <p>إجمالي الحجوزات</p>
                </div>
            </div>
            
            <h3>آخر النشاطات</h3>
            <table id="dashTable">
                <thead><tr><th>الكابتن</th><th>الملعب</th><th>التاريخ</th><th>الحالة</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="bookings" class="view-section">
            <h3>إدارة الحجوزات</h3>
            <table id="fullBookingsTable">
                <thead><tr><th>الكابتن</th><th>الملعب</th><th>السعر</th><th>الحالة</th><th>إجراء</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="finance" class="view-section">
            <h3>التقارير المالية (حسب الملعب)</h3>
            <div class="card-grid" id="financeGrid"></div>
        </div>
        
        <div id="settings" class="view-section">
            <h3>الإعدادات</h3>
            <div class="stat-card">
                <label>رقم الواتساب</label>
                <input type="text" id="setPhone" class="login-input">
                <label>العمولة (%)</label>
                <input type="number" id="setComm" class="login-input">
                <button class="login-btn" onclick="saveSettings()">حفظ</button>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAfn2LhKnsVGQmoAK_HexN_6bm2-NICNSY",
      authDomain: "tasdida.firebaseapp.com",
      projectId: "tasdida",
      storageBucket: "tasdida.firebasestorage.app",
      messagingSenderId: "72604782215",
      appId: "1:72604782215:web:38a014c331634398d9f222"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.login = async function() {
        const p = document.getElementById('adminPass').value;
        const snap = await getDoc(doc(db, "settings", "config"));
        const real = snap.exists() ? snap.data().adminPassword : "123";
        if(p === real) {
            document.getElementById('loginOverlay').style.display='none';
            loadData();
        } else { alert("خطأ في كلمة المرور"); }
    }

    window.switchView = (id, el) => {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        el.classList.add('active');
    }

    async function loadData() {
        const snap = await getDocs(collection(db, "bookings"));
        let income = 0, pending = 0, count = 0;
        let stadStats = {};
        const tbodyDash = document.querySelector('#dashTable tbody');
        const tbodyFull = document.querySelector('#fullBookingsTable tbody');
        
        tbodyDash.innerHTML = ''; tbodyFull.innerHTML = '';

        snap.forEach(d => {
            const r = d.data();
            const price = Number(r.price || 0);
            income += price;
            count++;
            if(r.status === 'pending') pending++;

            // Stats per stadium
            if(!stadStats[r.stadiumName]) stadStats[r.stadiumName] = 0;
            stadStats[r.stadiumName] += price;

            const badge = r.status === 'pending' ? '<span class="status-badge pending">انتظار</span>' : '<span class="status-badge confirmed">مؤكد</span>';
            const actions = `<button onclick="delBooking('${d.id}')" style="color:red;border:none;background:none;cursor:pointer;"><i class="fas fa-trash"></i></button>`;

            // Add to tables
            tbodyFull.innerHTML += `<tr><td>${r.clientName}</td><td>${r.stadiumName}</td><td>${price}</td><td>${badge}</td><td>${actions}</td></tr>`;
            if(count <= 5) tbodyDash.innerHTML += `<tr><td>${r.clientName}</td><td>${r.stadiumName}</td><td>${r.date}</td><td>${badge}</td></tr>`;
        });

        document.getElementById('dashIncome').innerText = income + " ريال";
        document.getElementById('dashPending').innerText = pending;
        document.getElementById('dashTotal').innerText = count;

        // Finance Grid
        const fGrid = document.getElementById('financeGrid');
        fGrid.innerHTML = '';
        for(let s in stadStats) {
            fGrid.innerHTML += `
                <div class="stat-card">
                    <h3>${stadStats[s]} ريال</h3>
                    <p>${s}</p>
                </div>
            `;
        }
    }

    window.delBooking = async (id) => {
        if(confirm("حذف؟")) { await deleteDoc(doc(db, "bookings", id)); loadData(); }
    }
    
    window.saveSettings = async () => {
        const ph = document.getElementById('setPhone').value;
        const cm = document.getElementById('setComm').value;
        await setDoc(doc(db, "settings", "config"), {adminPhone: ph, commission: cm}, {merge:true});
        alert("تم الحفظ");
    }
</script>
</body>
</html>
