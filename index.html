<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasdida - Ø­Ø¬Ø² Ù…Ù„Ø§Ø¹Ø¨</title>
    <style>
        :root { --primary: #25d366; --dark: #075e54; --bg: #f0f2f5; --selected: #e8f5e9; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 90px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tabs { display: flex; background: white; padding: 5px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; font-weight: bold; font-size: 16px; color: #777; border-radius: 10px; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 2px solid transparent; transition: 0.2s; }
        .stadium-card { display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .stadium-card.selected { border-color: var(--primary); background: var(--selected); }
        .stadium-card img { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø£ÙˆÙ‚Ø§Øª */
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .time-slot { padding: 10px; border: 1px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; font-size: 13px; background: white; transition: 0.2s; }
        .time-slot:hover { background: #f9f9f9; }
        .time-slot.selected { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }
        .time-slot.disabled { background: #eee; color: #aaa; cursor: not-allowed; text-decoration: line-through; }

        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… */
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; outline: none; }
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); text-align: center; z-index: 100; }
        .btn-main { background: var(--dark); color: white; border: none; padding: 15px; width: 100%; max-width: 600px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
        
        /* Ø§Ù„Ù…Ø±Ø§ÙƒØ² */
        .positions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; display: none; background: #fff8e1; padding: 10px; border-radius: 8px; }
        
        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© */
        .match-card { border-right: 5px solid #ff9800; }
        .btn-join { background: #25d366; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-top: 10px; width: 100%; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align: center; color: var(--dark); margin-bottom: 20px;">âš½ ØªØ·Ø¨ÙŠÙ‚ Tasdida</h2>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('booking')">Ø­Ø¬Ø² Ù…Ù„Ø¹Ø¨ ğŸŸï¸</button>
        <button class="tab-btn" onclick="switchTab('matches')">Ø§Ù†Ø¶Ù… Ù„ÙØ±ÙŠÙ‚ ğŸ¤</button>
    </div>

    <div id="bookingSection">
        <div class="card">
            <label>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ†:</label>
            <input type="text" id="clientName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
            
            <label>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²:</label>
            <input type="date" id="bookingDate" onchange="loadAvailableTimes()">

            <label>â° Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ø§Ø¹Ø©):</label>
            <div id="timeGrid" class="time-grid">
                <p style="grid-column: span 4; text-align:center; color:#777;">Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ù„Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª</p>
            </div>
            <p id="totalPriceDisplay" style="text-align:center; font-weight:bold; color:var(--dark); margin-top:10px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Ø±ÙŠØ§Ù„</p>

            <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                <label style="display:flex; align-items:center; cursor:pointer; gap:10px;">
                    <input type="checkbox" id="needsPlayers" onchange="togglePositions()" style="width: 20px; height: 20px;">
                    <span style="font-weight:bold; color:#d35400;">ÙØ±ÙŠÙ‚ÙŠ Ù†Ø§Ù‚Øµ ÙˆØ£Ø­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ†!</span>
                </label>
                
                <div id="positionsBox" class="positions-grid">
                    <p style="grid-column: span 2; margin:0 0 5px 0; font-size:12px;">Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ù†Ø§Ù‚ØµØ©:</p>
                    <label><input type="checkbox" value="Ø­Ø§Ø±Ø³" class="pos-select"> ğŸ§¤ Ø­Ø§Ø±Ø³</label>
                    <label><input type="checkbox" value="Ø¯ÙØ§Ø¹" class="pos-select"> ğŸ›¡ï¸ Ø¯ÙØ§Ø¹</label>
                    <label><input type="checkbox" value="ÙˆØ³Ø·" class="pos-select"> âš™ï¸ ÙˆØ³Ø·</label>
                    <label><input type="checkbox" value="Ù‡Ø¬ÙˆÙ…" class="pos-select"> âš½ Ù‡Ø¬ÙˆÙ…</label>
                </div>
            </div>
        </div>

        <h3 style="margin: 10px 0;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ø¹Ø¨:</h3>
        <div id="stadiumsList"></div>
    </div>

    <div id="matchesSection" style="display: none;">
        <div id="matchesList"></div>
    </div>
</div>

<div class="bottom-bar" id="bottomBar">
    <button id="bookBtn" class="btn-main" onclick="processBooking()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ğŸ”´ ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§ Ø¨Ù†Ø¬Ø§Ø­ ğŸ”´
    const firebaseConfig = {
      apiKey: "AIzaSyAfn2LhKnsVGQmoAK_HexN_6bm2-NICNSY",
      authDomain: "tasdida.firebaseapp.com",
      projectId: "tasdida",
      storageBucket: "tasdida.firebasestorage.app",
      messagingSenderId: "72604782215",
      appId: "1:72604782215:web:38a014c331634398d9f222",
      measurementId: "G-KV88C3MP0X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    let adminPhone = "";
    let workStart = 16; // Ø§ÙØªØ±Ø§Ø¶ÙŠ: 4 Ù…Ø³Ø§Ø¡Ù‹
    let workEnd = 26;   // Ø§ÙØªØ±Ø§Ø¶ÙŠ: 2 ÙØ¬Ø±Ø§Ù‹
    let selectedStadium = null;
    let selectedTimes = []; 

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    async function loadSettings() {
        try {
            const snap = await getDoc(doc(db, "settings", "config"));
            if(snap.exists()) {
                const data = snap.data();
                if(data.adminPhone) adminPhone = data.adminPhone;
                if(data.workStart) workStart = Number(data.workStart);
                if(data.workEnd) workEnd = Number(data.workEnd);
            }
        } catch(e) { console.log("Using defaults"); }
    }
    loadSettings();

    const stadiums = [
        { id: 1, name: "Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø¬ÙˆÙ‡Ø±Ø© (Ø§Ù„Ø´Ù…Ø§Ù„)", price: 150, img: "https://images.unsplash.com/photo-1575361204480-aadea25e6e68?w=200" },
        { id: 2, name: "Ù…Ù„Ø¹Ø¨ Ø§Ù„ÙƒØ§Ù…Ø¨ Ù†Ùˆ (Ø§Ù„Ø´Ø±Ù‚)", price: 200, img: "https://images.unsplash.com/photo-1522770179533-24471fcdba45?w=200" },
        { id: 3, name: "Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„Ù…Ø¨ÙŠ (Ø§Ù„ÙˆØ³Ø·)", price: 120, img: "https://images.unsplash.com/photo-1459865264687-595d652de67e?w=200" }
    ];

    // Ø±Ø³Ù… Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨
    const stContainer = document.getElementById('stadiumsList');
    stadiums.forEach(st => {
        const div = document.createElement('div');
        div.className = 'card stadium-card';
        div.onclick = () => {
            selectedStadium = st;
            document.querySelectorAll('.stadium-card').forEach(c => c.classList.remove('selected'));
            div.classList.add('selected');
            loadAvailableTimes();
        };
        div.innerHTML = `
            <img src="${st.img}">
            <div style="flex:1">
                <h3 style="margin:0;">${st.name}</h3>
                <span style="color:#25d366; font-weight:bold;">${st.price} Ø±ÙŠØ§Ù„ / Ø³Ø§Ø¹Ø©</span>
            </div>
        `;
        stContainer.appendChild(div);
    });

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª
    function formatTime(hour) {
        let h = hour % 24;
        let suffix = (h >= 12) ? 'Ù…' : 'Øµ';
        if (h > 12) h -= 12;
        if (h === 0) h = 12;
        return `${h}:00 ${suffix}`;
    }

    // ØªÙˆÙ„ÙŠØ¯ Ø´Ø¨ÙƒØ© Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
    window.loadAvailableTimes = async function() {
        const date = document.getElementById('bookingDate').value;
        const grid = document.getElementById('timeGrid');
        
        if(!date || !selectedStadium) return;

        grid.innerHTML = '<p style="grid-column:span 4; text-align:center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</p>';
        selectedTimes = [];
        updatePrice();

        const q = query(collection(db, "bookings"), 
            where("stadiumId", "==", selectedStadium.id),
            where("date", "==", date)
        );
        const snapshot = await getDocs(q);
        let bookedHours = [];
        snapshot.forEach(doc => {
            if(doc.data().bookedSlots) bookedHours.push(...doc.data().bookedSlots);
        });

        grid.innerHTML = '';
        for(let i = workStart; i < workEnd; i++) {
            let actualHour = i;
            const btn = document.createElement('div');
            btn.className = 'time-slot';
            btn.innerText = formatTime(actualHour);
            
            if(bookedHours.includes(actualHour)) {
                btn.classList.add('disabled');
                btn.innerText += " (Ù…Ø­Ø¬ÙˆØ²)";
            } else {
                btn.onclick = () => toggleTimeSelection(btn, actualHour);
            }
            grid.appendChild(btn);
        }
    }

    function toggleTimeSelection(btn, hour) {
        if(btn.classList.contains('disabled')) return;
        if(btn.classList.contains('selected')) {
            btn.classList.remove('selected');
            selectedTimes = selectedTimes.filter(t => t !== hour);
        } else {
            btn.classList.add('selected');
            selectedTimes.push(hour);
        }
        updatePrice();
    }

    function updatePrice() {
        if(selectedStadium) {
            const total = selectedTimes.length * selectedStadium.price;
            document.getElementById('totalPriceDisplay').innerText = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø±ÙŠØ§Ù„ (${selectedTimes.length} Ø³Ø§Ø¹Ø§Øª)`;
        }
    }

    window.togglePositions = function() {
        const box = document.getElementById('positionsBox');
        box.style.display = document.getElementById('needsPlayers').checked ? 'grid' : 'none';
    }

    window.switchTab = function(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('bookingSection').style.display = tab === 'booking' ? 'block' : 'none';
        document.getElementById('matchesSection').style.display = tab === 'matches' ? 'block' : 'none';
        document.getElementById('bottomBar').style.display = tab === 'booking' ? 'block' : 'none';
        if(tab === 'matches') loadMatches();
    }

    window.processBooking = async function() {
        const name = document.getElementById('clientName').value;
        const date = document.getElementById('bookingDate').value;
        const needsPlayers = document.getElementById('needsPlayers').checked;
        const btn = document.getElementById('bookBtn');

        let wantedPositions = [];
        if(needsPlayers) document.querySelectorAll('.pos-select:checked').forEach(cb => wantedPositions.push(cb.value));

        if(!name || !date || !selectedStadium || selectedTimes.length === 0) return alert("âš ï¸ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø®ØªØ± Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");

        btn.disabled = true;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø¬Ø²...";

        try {
            const totalPrice = selectedTimes.length * selectedStadium.price;
            selectedTimes.sort((a,b) => a - b);
            const timeString = selectedTimes.map(t => formatTime(t)).join('ØŒ ');

            await addDoc(collection(db, "bookings"), {
                clientName: name,
                stadiumId: selectedStadium.id,
                stadiumName: selectedStadium.name,
                date: date,
                bookedSlots: selectedTimes,
                timeDisplay: timeString,
                price: totalPrice,
                needsPlayers: needsPlayers,
                wantedPositions: wantedPositions,
                paidToOwner: false,
                createdAt: new Date().toISOString()
            });

            alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ù„Ù„ØªØ£ÙƒÙŠØ¯!");
            
            let msg = `Ø·Ù„Ø¨ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯ ğŸ†•\nğŸŸï¸ ${selectedStadium.name}\nğŸ‘¤ ${name}\nğŸ“… ${date}\nâ° Ø§Ù„Ø£ÙˆÙ‚Ø§Øª: ${timeString}\nğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalPrice} Ø±ÙŠØ§Ù„`;
            if(needsPlayers) msg += `\nâš ï¸ Ù…Ø·Ù„ÙˆØ¨ Ù„Ø§Ø¹Ø¨ÙŠÙ†: ${wantedPositions.join('ØŒ ')}`;
            
            window.open(`https://wa.me/${adminPhone}?text=${encodeURIComponent(msg)}`, '_blank');
            location.reload();

        } catch (e) {
            console.error(e);
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
            btn.disabled = false;
        }
    }

    async function loadMatches() {
        const list = document.getElementById('matchesList');
        list.innerHTML = '<p style="text-align:center">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';
        const q = query(collection(db, "bookings"), where("needsPlayers", "==", true));
        const snap = await getDocs(q);
        list.innerHTML = '';
        if(snap.empty) { list.innerHTML = '<p style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù…ØªØ§Ø­Ø©.</p>'; return; }

        snap.forEach(doc => {
            const data = doc.data();
            if(new Date(data.date) >= new Date().setHours(0,0,0,0)) {
                let posHtml = data.wantedPositions ? data.wantedPositions.map(p=>`<span style="background:#ff9800;color:white;padding:2px 6px;border-radius:4px;font-size:12px;margin:2px;">${p}</span>`).join('') : '';
                list.innerHTML += `
                    <div class="card match-card">
                        <h3>${data.stadiumName}</h3>
                        <p>ğŸ“… ${data.date} | â° ${data.timeDisplay}</p>
                        <p>ğŸ‘¤ Ø§Ù„ÙƒØ§Ø¨ØªÙ†: ${data.clientName}</p>
                        <div><strong>Ù…Ø·Ù„ÙˆØ¨:</strong> ${posHtml}</div>
                        <button class="btn-join" onclick="window.open('https://wa.me/${adminPhone}?text=Ø£Ø±ÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ${data.clientName}', '_blank')">ğŸ“© Ø§Ù†Ø¶Ù…Ø§Ù…</button>
                    </div>`;
            }
        });
    }
</script>
</body>
</html>
