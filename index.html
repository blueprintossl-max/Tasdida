<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¯ÙŠØ¯Ø© Ù…Ø­ØªØ±Ù | Ø­Ø¬Ø² Ù…Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¹Ø§Ø±Ø¶Ø©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #10b981; --secondary: #3b82f6; --dark: #0f172a; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 100px; color: var(--dark); }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¨ØµØ±ÙŠØ© */
        header { text-align: center; margin: 30px 0; }
        .brand-h1 { font-size: 36px; font-weight: 900; margin: 0; background: linear-gradient(45deg, var(--dark), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .brand-p { color: var(--primary); font-weight: bold; font-size: 18px; margin-top: -5px; }

        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        label { display: block; margin-bottom: 10px; font-weight: bold; color: #64748b; font-size: 14px; }
        select, input { width: 100%; padding: 14px; border: 2px solid #f1f5f9; border-radius: 12px; margin-bottom: 15px; box-sizing: border-box; outline: none; transition: 0.3s; }
        select:focus, input:focus { border-color: var(--primary); background: #fff; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø³Ø§Ø¹Ø§Øª */
        .time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .time-slot { padding: 12px; border: 2px solid #f1f5f9; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.2s; font-size: 13px; font-weight: 600; }
        .time-slot.selected { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }
        .time-slot.booked { background: #f1f5f9; color: #cbd5e1; cursor: not-allowed; text-decoration: line-through; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ (Modal) */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: 25px; width: 100%; max-width: 400px; text-align: center; }

        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 20px; box-shadow: 0 -10px 30px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: space-between; z-index: 100; border-top-left-radius: 25px; border-top-right-radius: 25px; }
        .btn-pay { background: var(--dark); color: white; border: none; padding: 15px 35px; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 class="brand-h1">ØªØ³Ø¯ÙŠØ¯Ø© Ù…Ø­ØªØ±Ù</h1>
        <p class="brand-p">Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ø¹Ø§Ø±Ø¶Ø©</p>
    </header>

    <div class="card">
        <label><i class="fas fa-map-marker-alt"></i> Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ø¹Ø¨:</label>
        <select id="stadiumSelect" onchange="loadStadiumData()">
            <option value="">-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨... --</option>
        </select>

        <div id="stadiumInfo" style="display:none; margin-bottom:15px; font-size:13px; color:#64748b;">
            <i class="fas fa-users"></i> Ø§Ù„Ø³Ø¹Ø©: <span id="stSize"></span> | <i class="fas fa-tag"></i> Ø§Ù„Ø³Ø¹Ø±: <span id="stPrice"></span> Ø±ÙŠØ§Ù„
        </div>

        <label><i class="fas fa-calendar-day"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²:</label>
        <input type="date" id="bookDate" onchange="loadAvailability()">

        <label><i class="fas fa-clock"></i> Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:</label>
        <div id="timeGrid" class="time-grid"></div>
    </div>

    <div class="card">
        <input type="text" id="capName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ†">
        <div style="display:flex; align-items:center; gap:10px; background:#f0f9ff; padding:10px; border-radius:10px;">
            <input type="checkbox" id="needsPlayers" style="width:20px; margin:0;">
            <span style="font-size:14px; color:#0369a1; font-weight:bold;">Ù†Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­ØªØ±ÙÙŠÙ† Ù„ØªÙƒÙ…Ù„Ø© Ø§Ù„ÙØ±ÙŠÙ‚</span>
        </div>
    </div>
</div>

<div class="modal-overlay" id="confirmModal">
    <div class="modal-content">
        <i class="fas fa-check-circle" style="font-size:50px; color:var(--primary); margin-bottom:15px;"></i>
        <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</h3>
        <div id="summaryText" style="text-align:right; font-size:14px; line-height:1.8; margin-bottom:20px;"></div>
        <button class="btn-pay" style="width:100%; justify-content:center;" onclick="sendToWhatsApp()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† <i class="fab fa-whatsapp"></i></button>
        <button onclick="closeModal()" style="background:none; border:none; margin-top:15px; color:#64748b; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div class="bottom-bar">
    <div>
        <div style="font-size:12px; color:#64748b;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</div>
        <div id="totalDisplay" style="font-size:22px; font-weight:900; color:var(--primary);">0 Ø±ÙŠØ§Ù„</div>
    </div>
    <button class="btn-pay" onclick="openConfirm()">Ø­Ø¬Ø² <i class="fas fa-arrow-left"></i></button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ÙƒÙˆØ¯ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
    const firebaseConfig = {
      apiKey: "AIzaSyAfn2LhKnsVGQmoAK_HexN_6bm2-NICNSY",
      authDomain: "tasdida.firebaseapp.com",
      projectId: "tasdida",
      storageBucket: "tasdida.firebasestorage.app",
      messagingSenderId: "72604782215",
      appId: "1:72604782215:web:38a014c331634398d9f222",
      measurementId: "G-KV88C3MP0X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let selectedHours = [];
    let currentStadium = null;
    let adminPhone = "";

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function init() {
        const select = document.getElementById('stadiumSelect');
        const config = await getDoc(doc(db, "settings", "config"));
        if(config.exists()) adminPhone = config.data().adminPhone;

        const snap = await getDocs(collection(db, "stadiums"));
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ø¹Ø¨ --</option>';
        snap.forEach(d => {
            select.innerHTML += `<option value="${d.id}">${d.data().name}</option>`;
        });
    }
    init();

    window.loadStadiumData = async function() {
        const id = document.getElementById('stadiumSelect').value;
        if(!id) return;
        const snap = await getDoc(doc(db, "stadiums", id));
        currentStadium = snap.data();
        document.getElementById('stadiumInfo').style.display = 'block';
        document.getElementById('stSize').innerText = currentStadium.size || '7 Ø¶Ø¯ 7';
        document.getElementById('stPrice').innerText = currentStadium.price;
        loadAvailability();
    }

    window.loadAvailability = async function() {
        const date = document.getElementById('bookDate').value;
        const grid = document.getElementById('timeGrid');
        if(!date || !currentStadium) return;
        
        grid.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</p>';
        selectedHours = []; updatePrice();

        const q = query(collection(db, "bookings"), where("stadiumName", "==", currentStadium.name), where("date", "==", date));
        const snap = await getDocs(q);
        let booked = []; snap.forEach(d => booked.push(...(d.data().bookedSlots || [])));

        grid.innerHTML = '';
        for(let h=16; h<=26; h++) {
            const div = document.createElement('div');
            div.className = 'time-slot' + (booked.includes(h) ? ' booked' : '');
            div.innerText = (h%12 || 12) + ':00 ' + (h>=12 && h<24 ? 'Ù…' : 'Øµ');
            if(!booked.includes(h)) div.onclick = () => {
                div.classList.toggle('selected');
                if(selectedHours.includes(h)) selectedHours = selectedHours.filter(x => x!==h);
                else selectedHours.push(h);
                updatePrice();
            };
            grid.appendChild(div);
        }
    }

    function updatePrice() {
        const total = selectedHours.length * (currentStadium?.price || 0);
        document.getElementById('totalDisplay').innerText = total + " Ø±ÙŠØ§Ù„";
    }

    window.openConfirm = function() {
        const name = document.getElementById('capName').value;
        if(!name || selectedHours.length === 0) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        document.getElementById('summaryText').innerHTML = `
            <b>Ø§Ù„Ù…Ù„Ø¹Ø¨:</b> ${currentStadium.name}<br>
            <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${document.getElementById('bookDate').value}<br>
            <b>Ø§Ù„Ø³Ø§Ø¹Ø§Øª:</b> ${selectedHours.length}<br>
            <b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</b> ${selectedHours.length * currentStadium.price} Ø±ÙŠØ§Ù„
        `;
        document.getElementById('confirmModal').style.display = 'flex';
    }

    window.closeModal = () => document.getElementById('confirmModal').style.display = 'none';

    window.sendToWhatsApp = async function() {
        const name = document.getElementById('capName').value;
        const date = document.getElementById('bookDate').value;
        const total = selectedHours.length * currentStadium.price;
        
        await addDoc(collection(db, "bookings"), {
            clientName: name, stadiumName: currentStadium.name, date,
            bookedSlots: selectedHours, price: total, createdAt: new Date().toISOString()
        });

        const msg = `*Ø·Ù„Ø¨ Ø­Ø¬Ø² - ØªØ³Ø¯ÙŠØ¯Ø© Ù…Ø­ØªØ±Ù*\nğŸ‘¤ Ø§Ù„ÙƒØ§Ø¨ØªÙ†: ${name}\nğŸŸï¸ Ø§Ù„Ù…Ù„Ø¹Ø¨: ${currentStadium.name}\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}\nğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø±ÙŠØ§Ù„`;
        window.open(`https://wa.me/${adminPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        location.reload();
   }
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨ Ù…Ø¹ Ø®Ø§ØµÙŠØ© "Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ"
    async function init() {
        const select = document.getElementById('stadiumSelect');
        const config = await getDoc(doc(db, "settings", "config"));
        if(config.exists()) adminPhone = config.data().adminPhone;

        const snap = await getDocs(collection(db, "stadiums"));
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©ØŒ Ø³Ù†Ø¶ÙŠÙ Ù…Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¹Ø§Ø±Ø¶Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙˆØ±Ø§Ù‹
        if (snap.empty) {
            const defaultStadiums = [
                { name: "Ù…Ù„Ø¹Ø¨ Ø¨Ù„Ø¯ÙŠØ© Ø§Ù„Ø¹Ø§Ø±Ø¶Ø©", price: 150, size: "9 Ø¶Ø¯ 9" },
                { name: "Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø±ÙˆØ§Ø¯ (Ø§Ù„Ø¹Ø§Ø±Ø¶Ø©)", price: 140, size: "7 Ø¶Ø¯ 7" },
                { name: "Ù…Ù„Ø¹Ø¨ Ø§Ù„Ù…Ø´Ø§Ù", price: 130, size: "6 Ø¶Ø¯ 6" }
            ];
            
            for (const st of defaultStadiums) {
                await addDoc(collection(db, "stadiums"), st);
            }
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
            location.reload(); 
            return;
        }

        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ø¹Ø¨ --</option>';
        snap.forEach(d => {
            select.innerHTML += `<option value="${d.id}">${d.data().name}</option>`;
        });
    }
    init();
</script>
</body>
</html>

