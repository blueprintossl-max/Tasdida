<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasdida - Ø­Ø¬Ø² ÙˆÙ…Ø¨Ø§Ø±ÙŠØ§Øª</title>
    <style>
        :root { --primary: #25d366; --secondary: #128c7e; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; padding-bottom: 80px; color: var(--text); }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Ø§Ù„Ø±Ø£Ø³ */
        header { text-align: center; margin-bottom: 30px; }
        header h1 { color: #075e54; margin: 0; font-size: 28px; }
        header p { color: #666; font-size: 14px; margin-top: 5px; }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 2px solid transparent; transition: 0.2s; }
        .stadium-card { cursor: pointer; display: flex; align-items: center; gap: 15px; }
        .stadium-card:hover { transform: translateY(-2px); }
        .stadium-card.selected { border-color: var(--primary); background: #e8f5e9; }
        .stadium-card img { width: 70px; height: 70px; border-radius: 8px; object-fit: cover; background: #eee; }
        
        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        .input-group { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.9em; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; outline: none; }
        input:focus, select:focus { border-color: var(--primary); }

        /* Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .match-card { border-right: 4px solid #ff9800; background: #fff3e0; }
        .match-info { font-size: 0.9em; margin-bottom: 10px; }
        .btn-join { background: #ff9800; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }

        /* Ø§Ù„Ø²Ø± Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); text-align: center; z-index: 100; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 15px 30px; width: 100%; max-width: 600px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-main:disabled { background: #ccc; cursor: not-allowed; }
        
        /* Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ */
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: none; background: #ddd; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>âš½ ØªØ·Ø¨ÙŠÙ‚ Tasdida</h1>
        <p>Ø§Ø­Ø¬Ø² Ù…Ù„Ø¹Ø¨Ùƒ .. Ø£Ùˆ Ø§Ù†Ø¶Ù… Ù„ÙØ±ÙŠÙ‚!</p>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('booking')">Ø­Ø¬Ø² Ù…Ù„Ø¹Ø¨ ğŸŸï¸</button>
        <button class="tab-btn" onclick="switchTab('matches')">Ø§Ù†Ø¶Ù… Ù„ÙØ±ÙŠÙ‚ ğŸ¤</button>
    </div>

    <div id="bookingSection">
        <div class="input-group">
            <label>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ:</label>
            <input type="text" id="clientName" placeholder="Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡">
            
            <label>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²:</label>
            <input type="date" id="bookingDate">
            
            <label>â° Ø§Ù„ÙˆÙ‚Øª:</label>
            <select id="bookingTime">
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª --</option>
                <option value="16:00">4:00 Ø¹ØµØ±Ø§Ù‹</option>
                <option value="17:00">5:00 Ø¹ØµØ±Ø§Ù‹</option>
                <option value="18:00">6:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                <option value="19:00">7:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                <option value="20:00">8:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                <option value="21:00">9:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                <option value="22:00">10:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                <option value="23:00">11:00 Ù…Ø³Ø§Ø¡Ù‹</option>
            </select>

            <div style="margin-top: 15px; padding: 10px; background: #fff3e0; border-radius: 8px;">
                <label style="display:flex; align-items:center; gap:10px; margin:0; cursor:pointer;">
                    <input type="checkbox" id="needsPlayers" style="width:20px; margin:0;">
                    <span>ÙŠÙ†Ù‚ØµÙ†Ø§ Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ø§Ø³Ù…Ø­ Ù„Ù„Ø¢Ø®Ø±ÙŠÙ† Ø¨Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…)</span>
                </label>
            </div>
        </div>

        <h3 style="margin-bottom: 10px;">ğŸŸï¸ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ø¹Ø¨:</h3>
        <div id="stadiumsList"></div>
        
        <div style="height: 80px;"></div> </div>

    <div id="matchesSection" style="display: none;">
        <h3>ğŸ”¥ Ù…Ø¨Ø§Ø±ÙŠØ§Øª ØªØ¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3>
        <div id="matchesList">
            <p style="text-align:center; color:#777;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¨Ø§Ø±ÙŠØ§Øª...</p>
        </div>
    </div>
</div>

<div class="bottom-bar" id="bottomBar">
    <button id="bookBtn" class="btn-main" onclick="processBooking()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² âœ…</button>
    <div id="statusMsg" style="margin-top:10px; font-weight:bold;"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ğŸ”´ğŸ”´ Ù‡Ø§Ù…: Ø§Ù„ØµÙ‚ ÙƒÙˆØ¯ Firebase Config Ù‡Ù†Ø§ ğŸ”´ğŸ”´
    const firebaseConfig = {
        // ... Ø§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§ ...
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let adminPhone = ""; 
    let selectedStadium = null;

    // Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
    async function fetchAdminPhone() {
        try {
            const docSnap = await getDoc(doc(db, "settings", "config"));
            if (docSnap.exists()) adminPhone = docSnap.data().adminPhone;
        } catch (error) { console.error(error); }
    }
    fetchAdminPhone();

    // Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨
    const stadiums = [
        { id: 1, name: "Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø¬ÙˆÙ‡Ø±Ø© (Ø§Ù„Ø´Ù…Ø§Ù„)", price: 150, img: "https://images.unsplash.com/photo-1529900748604-07564a03e7a6?w=100" },
        { id: 2, name: "Ù…Ù„Ø¹Ø¨ Ø§Ù„ÙƒØ§Ù…Ø¨ Ù†Ùˆ (Ø§Ù„Ø´Ø±Ù‚)", price: 200, img: "https://images.unsplash.com/photo-1459865264687-595d652de67e?w=100" },
        { id: 3, name: "Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„Ù…Ø¨ÙŠ (Ø§Ù„ÙˆØ³Ø·)", price: 120, img: "https://images.unsplash.com/photo-1574629810360-7efbbe195018?w=100" }
    ];

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨
    const stContainer = document.getElementById('stadiumsList');
    stadiums.forEach(stadium => {
        const div = document.createElement('div');
        div.className = 'card stadium-card';
        div.onclick = () => {
            selectedStadium = stadium;
            document.querySelectorAll('.stadium-card').forEach(c => c.classList.remove('selected'));
            div.classList.add('selected');
        };
        div.innerHTML = `
            <img src="${stadium.img}" alt="Ù…Ù„Ø¹Ø¨">
            <div style="flex:1">
                <h3 style="margin:0 0 5px 0;">${stadium.name}</h3>
                <span style="color:#25d366; font-weight:bold;">${stadium.price} Ø±ÙŠØ§Ù„</span>
            </div>
        `;
        stContainer.appendChild(div);
    });

    // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    window.switchTab = function(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        if(tab === 'booking') {
            document.getElementById('bookingSection').style.display = 'block';
            document.getElementById('matchesSection').style.display = 'none';
            document.getElementById('bottomBar').style.display = 'block';
        } else {
            document.getElementById('bookingSection').style.display = 'none';
            document.getElementById('matchesSection').style.display = 'block';
            document.getElementById('bottomBar').style.display = 'none';
            loadOpenMatches(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©
        }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ†
    async function loadOpenMatches() {
        const list = document.getElementById('matchesList');
        list.innerHTML = '<p style="text-align:center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
        
        try {
            // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ© Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ†
            const today = new Date().toISOString().split('T')[0];
            const q = query(collection(db, "bookings"), 
                where("needsPlayers", "==", true),
                where("date", ">=", today),
                orderBy("date"), orderBy("time")
            );

            const snapshot = await getDocs(q);
            list.innerHTML = '';
            
            if(snapshot.empty) {
                list.innerHTML = '<p style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª ØªØ¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                list.innerHTML += `
                    <div class="card match-card">
                        <div class="match-info">
                            <strong>âš½ ${data.stadiumName}</strong><br>
                            ğŸ“… ${data.date} | â° ${data.time}<br>
                            ğŸ‘¤ Ø§Ù„Ù…Ù†Ø¸Ù…: ${data.clientName}
                        </div>
                        <button class="btn-join" onclick="joinMatch('${data.clientName}', '${data.date}', '${data.time}')">Ø§Ø±Ø³Ù„ Ø·Ù„Ø¨ Ø§Ù†Ø¶Ù…Ø§Ù… ğŸ’¬</button>
                    </div>
                `;
            });

        } catch (e) { console.error(e); list.innerHTML = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„'; }
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… (ÙˆØ§ØªØ³Ø§Ø¨)
    window.joinMatch = function(hostName, date, time) {
        if(!adminPhone) return alert("Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„ ØºÙŠØ± Ù…ØªÙˆÙØ±");
        const msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ØºØ¨ Ø¨Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø©:\nØ§Ù„Ù…Ù†Ø¸Ù…: ${hostName}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${date} Ø§Ù„Ø³Ø§Ø¹Ø© ${time}\nÙ‡Ù„ ÙŠÙˆØ¬Ø¯ Ù…ÙƒØ§Ù†ØŸ`;
        window.open(`https://wa.me/${adminPhone}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø¬Ø²
    window.processBooking = async function() {
        const name = document.getElementById('clientName').value;
        const date = document.getElementById('bookingDate').value;
        const time = document.getElementById('bookingTime').value;
        const needsPlayers = document.getElementById('needsPlayers').checked;
        const btn = document.getElementById('bookBtn');
        const msg = document.getElementById('statusMsg');

        if (!adminPhone) return alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ù†Ø¸Ø§Ù… Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© (Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·)");
        if (!name || !date || !time || !selectedStadium) return alert("Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");

        btn.disabled = true;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø¬Ø²...";
        msg.innerText = "";

        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙØ±
            const q = query(collection(db, "bookings"), 
                where("stadiumId", "==", selectedStadium.id),
                where("date", "==", date),
                where("time", "==", time)
            );
            
            if (!(await getDocs(q)).empty) {
                msg.innerText = "â›” Ø§Ù„ÙˆÙ‚Øª Ù…Ø­Ø¬ÙˆØ² Ù…Ø³Ø¨Ù‚Ø§Ù‹!";
                msg.style.color = "red";
                btn.disabled = false;
                return;
            }

            // Ø§Ù„Ø­ÙØ¸
            await addDoc(collection(db, "bookings"), {
                clientName: name,
                stadiumId: selectedStadium.id,
                stadiumName: selectedStadium.name,
                date: date,
                time: time,
                price: selectedStadium.price,
                needsPlayers: needsPlayers, // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ÙŠÙ†
                paidToOwner: false, // Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ù…Ø§Ù„Ùƒ (Ù„Ù„Ù…Ø­Ø§Ø³Ø¨Ø©)
                createdAt: new Date()
            });

            msg.innerText = "âœ… ØªÙ… Ø§Ù„Ø­Ø¬Ø²! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...";
            msg.style.color = "green";
            
            setTimeout(() => {
                let waMsg = `Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯ *${selectedStadium.name}*\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\nğŸ“… ${date} | â° ${time}\nğŸ’° ${selectedStadium.price} Ø±ÙŠØ§Ù„`;
                if(needsPlayers) waMsg += `\nâš ï¸ *Ù…Ù„Ø§Ø­Ø¸Ø©:* ÙØ±ÙŠÙ‚ÙŠ Ù†Ø§Ù‚Øµ ÙˆØ£Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ÙŠÙ†!`;
                
                window.open(`https://wa.me/${adminPhone}?text=${encodeURIComponent(waMsg)}`, '_blank');
                location.reload();
            }, 1500);

        } catch (error) {
            console.error(error);
            msg.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
