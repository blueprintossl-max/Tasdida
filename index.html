<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¹Ø§Ø±Ø¶Ø© - Ø­Ø¬Ø² ÙˆÙ…Ø¨Ø§Ø±ÙŠØ§Øª</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #198754; --dark: #1e293b; --bg: #f8fafc; --accent: #f59e0b; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; padding-bottom: 100px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Ø§Ù„Ø±Ø£Ø³ */
        header { text-align: center; margin-bottom: 30px; }
        header h1 { color: var(--dark); font-size: 24px; margin: 0; }
        header p { color: #64748b; margin-top: 5px; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨ */
        .stadiums-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .stadium-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); cursor: pointer; transition: 0.3s; border: 2px solid transparent; }
        .stadium-card:hover { transform: translateY(-5px); }
        .stadium-card.selected { border-color: var(--primary); ring: 2px solid var(--primary); }
        
        .card-img { height: 160px; background: #eee; position: relative; }
        .card-img img { width: 100%; height: 100%; object-fit: cover; }
        .badge-size { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        
        .card-body { padding: 15px; }
        .card-title { font-weight: bold; font-size: 18px; margin: 0 0 5px 0; color: var(--dark); }
        .card-price { color: var(--primary); font-weight: bold; font-size: 16px; float: left; }
        
        /* Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ù„ÙˆÙ‚Øª */
        .booking-box { background: white; padding: 20px; border-radius: 15px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        .time-slot { padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .time-slot:hover { background: #f1f5f9; }
        .time-slot.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .time-slot.disabled { background: #cbd5e1; color: #94a3b8; cursor: not-allowed; text-decoration: line-through; }

        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; outline: none; }
        
        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; z-index: 100; max-width: 800px; margin: 0 auto; border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .total-price { font-weight: bold; font-size: 18px; color: var(--dark); }
        .btn-main { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        
        /* Ø®ÙŠØ§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .player-toggle { display: flex; align-items: center; gap: 10px; background: #fff7ed; padding: 10px; border-radius: 8px; border: 1px solid #ffedd5; margin-top: 15px; }
        .positions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>âš½ Ù…Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¹Ø§Ø±Ø¶Ø©</h1>
        <p>Ø§Ø­Ø¬Ø² Ù…Ù„Ø¹Ø¨Ùƒ Ø§Ù„Ù…ÙØ¶Ù„ ÙÙŠ Ø«ÙˆØ§Ù†Ù</p>
    </header>

    <h3 style="margin-bottom:15px;"><i class="fas fa-map-marker-alt"></i> Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ø¹Ø¨:</h3>
    <div id="stadiumsList" class="stadiums-grid"></div>

    <div id="bookingSection" class="booking-box" style="display:none;">
        <h3 id="selectedStadiumTitle" style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;"></h3>
        
        <label><i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ†:</label>
        <input type="text" id="clientName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
        
        <label><i class="fas fa-calendar-alt"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²:</label>
        <input type="date" id="bookingDate" onchange="loadAvailableTimes()">

        <label style="display:block; margin-top:10px;"><i class="fas fa-clock"></i> Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:</label>
        <div id="timeGrid" class="time-grid">
            <p style="grid-column:span 4; text-align:center; color:#777;">Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹</p>
        </div>

        <div class="player-toggle">
            <input type="checkbox" id="needsPlayers" onchange="togglePositions()" style="width:20px; margin:0;">
            <span style="color:#c2410c; font-weight:bold;">ÙŠÙ†Ù‚ØµÙ†Ø§ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø©ØŸ</span>
        </div>
        <div id="positionsBox" class="positions-grid">
            <label><input type="checkbox" value="Ø­Ø§Ø±Ø³" class="pos-select"> ğŸ§¤ Ø­Ø§Ø±Ø³</label>
            <label><input type="checkbox" value="Ø¯ÙØ§Ø¹" class="pos-select"> ğŸ›¡ï¸ Ø¯ÙØ§Ø¹</label>
            <label><input type="checkbox" value="ÙˆØ³Ø·" class="pos-select"> âš™ï¸ ÙˆØ³Ø·</label>
            <label><input type="checkbox" value="Ù‡Ø¬ÙˆÙ…" class="pos-select"> âš½ Ù‡Ø¬ÙˆÙ…</label>
        </div>
    </div>
</div>

<div class="bottom-bar" id="bottomBar" style="display:none;">
    <div class="total-price" id="totalPriceDisplay">0 Ø±ÙŠØ§Ù„</div>
    <button id="bookBtn" class="btn-main" onclick="processBooking()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² <i class="fas fa-check-circle"></i></button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ğŸ”´ ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ğŸ”´
    const firebaseConfig = {
      apiKey: "AIzaSyAfn2LhKnsVGQmoAK_HexN_6bm2-NICNSY",
      authDomain: "tasdida.firebaseapp.com",
      projectId: "tasdida",
      storageBucket: "tasdida.firebasestorage.app",
      messagingSenderId: "72604782215",
      appId: "1:72604782215:web:38a014c331634398d9f222",
      measurementId: "G-KV88C3MP0X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ù…ØªØºÙŠØ±Ø§Øª
    let adminPhone = "";
    let workStart = 16;
    let workEnd = 26;
    let selectedStadium = null;
    let selectedTimes = [];

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    getDoc(doc(db, "settings", "config")).then(snap => {
        if(snap.exists()) {
            const d = snap.data();
            adminPhone = d.adminPhone;
            if(d.workStart) workStart = Number(d.workStart);
            if(d.workEnd) workEnd = Number(d.workEnd);
        }
    });

    // ğŸŸï¸ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¹Ø§Ø±Ø¶Ø© (Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ‚Ø¯ÙŠØ±ÙŠØ©)
    const stadiums = [
        { id: 1, name: "Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø´Ù„Ø§Ù„", price: 150, size: "7 vs 7", img: "https://images.unsplash.com/photo-1529900748604-07564a03e7a6?w=400" },
        { id: 2, name: "Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", price: 140, size: "6 vs 6", img: "https://images.unsplash.com/photo-1575361204480-aadea25e6e68?w=400" },
        { id: 3, name: "Ù…Ù„Ø¹Ø¨ Ø§Ù„Ù†Ø®Ø¨Ø©", price: 160, size: "8 vs 8", img: "https://images.unsplash.com/photo-1459865264687-595d652de67e?w=400" },
        { id: 4, name: "Ù…Ù„Ø¹Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠ", price: 130, size: "5 vs 5", img: "https://images.unsplash.com/photo-1522770179533-24471fcdba45?w=400" },
        { id: 5, name: "Ù…Ù„Ø¹Ø¨ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ø±Ø¶Ø©", price: 180, size: "9 vs 9", img: "https://images.unsplash.com/photo-1518605348435-2242085dbb3c?w=400" },
        { id: 6, name: "Ù…Ù„Ø¹Ø¨ Ø§Ù„Ù‚Ù…Ø©", price: 150, size: "7 vs 7", img: "https://images.unsplash.com/photo-1556612000-848e02927284?w=400" }
    ];

    // Ø±Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    const container = document.getElementById('stadiumsList');
    stadiums.forEach(st => {
        const div = document.createElement('div');
        div.className = 'stadium-card';
        div.onclick = () => selectStadium(st, div);
        div.innerHTML = `
            <div class="card-img">
                <img src="${st.img}" alt="${st.name}">
                <span class="badge-size"><i class="fas fa-users"></i> ${st.size}</span>
            </div>
            <div class="card-body">
                <h3 class="card-title">${st.name}</h3>
                <span class="card-price">${st.price} Ø±ÙŠØ§Ù„ / Ø³Ø§Ø¹Ø©</span>
                <div style="clear:both;"></div>
            </div>
        `;
        container.appendChild(div);
    });

    function selectStadium(st, element) {
        selectedStadium = st;
        document.querySelectorAll('.stadium-card').forEach(c => c.classList.remove('selected'));
        element.classList.add('selected');
        
        document.getElementById('bookingSection').style.display = 'block';
        document.getElementById('bottomBar').style.display = 'flex';
        document.getElementById('selectedStadiumTitle').innerText = `Ø­Ø¬Ø²: ${st.name}`;
        
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„ Ù‚Ù„ÙŠÙ„Ø§Ù‹
        document.getElementById('bookingSection').scrollIntoView({behavior: "smooth"});
        loadAvailableTimes();
    }

    function formatTime(hour) {
        let h = hour % 24;
        let suffix = (h >= 12) ? 'Ù…' : 'Øµ';
        if (h > 12) h -= 12;
        if (h === 0) h = 12;
        return `${h}:00 ${suffix}`;
    }

    window.loadAvailableTimes = async function() {
        const date = document.getElementById('bookingDate').value;
        const grid = document.getElementById('timeGrid');
        
        if(!date || !selectedStadium) return;

        grid.innerHTML = '<p style="grid-column:span 4; text-align:center"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</p>';
        selectedTimes = [];
        updatePrice();

        const q = query(collection(db, "bookings"), 
            where("stadiumId", "==", selectedStadium.id),
            where("date", "==", date)
        );
        const snapshot = await getDocs(q);
        let bookedHours = [];
        snapshot.forEach(doc => {
            if(doc.data().bookedSlots) bookedHours.push(...doc.data().bookedSlots);
        });

        grid.innerHTML = '';
        for(let i = workStart; i < workEnd; i++) {
            let actualHour = i;
            const btn = document.createElement('div');
            btn.className = 'time-slot';
            btn.innerText = formatTime(actualHour);
            
            if(bookedHours.includes(actualHour)) {
                btn.classList.add('disabled');
                btn.style.opacity = "0.5";
            } else {
                btn.onclick = () => toggleTime(btn, actualHour);
            }
            grid.appendChild(btn);
        }
    }

    function toggleTime(btn, hour) {
        if(btn.classList.contains('disabled')) return;
        if(btn.classList.contains('selected')) {
            btn.classList.remove('selected');
            selectedTimes = selectedTimes.filter(t => t !== hour);
        } else {
            btn.classList.add('selected');
            selectedTimes.push(hour);
        }
        updatePrice();
    }

    function updatePrice() {
        if(selectedStadium) {
            const total = selectedTimes.length * selectedStadium.price;
            document.getElementById('totalPriceDisplay').innerText = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø±ÙŠØ§Ù„`;
        }
    }

    window.togglePositions = function() {
        const box = document.getElementById('positionsBox');
        box.style.display = document.getElementById('needsPlayers').checked ? 'grid' : 'none';
    }

    window.processBooking = async function() {
        const name = document.getElementById('clientName').value;
        const date = document.getElementById('bookingDate').value;
        const needsPlayers = document.getElementById('needsPlayers').checked;
        const btn = document.getElementById('bookBtn');

        let wantedPositions = [];
        if(needsPlayers) document.querySelectorAll('.pos-select:checked').forEach(cb => wantedPositions.push(cb.value));

        if(!name || !date || selectedTimes.length === 0) return alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª");

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø¬Ø²...';

        try {
            const totalPrice = selectedTimes.length * selectedStadium.price;
            selectedTimes.sort((a,b) => a - b);
            const timeString = selectedTimes.map(t => formatTime(t)).join('ØŒ ');

            await addDoc(collection(db, "bookings"), {
                clientName: name,
                stadiumId: selectedStadium.id,
                stadiumName: selectedStadium.name,
                date: date,
                bookedSlots: selectedTimes,
                timeDisplay: timeString,
                price: totalPrice,
                needsPlayers: needsPlayers,
                wantedPositions: wantedPositions,
                paidToOwner: false,
                createdAt: new Date().toISOString()
            });

            // Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
            let msg = `*Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯ - ${selectedStadium.name}* ğŸŸï¸\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}\nâ° Ø§Ù„ÙˆÙ‚Øª: ${timeString}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${totalPrice} Ø±ÙŠØ§Ù„`;
            if(needsPlayers) msg += `\nâš ï¸ *Ù…Ø·Ù„ÙˆØ¨ Ù„Ø§Ø¹Ø¨ÙŠÙ†:* ${wantedPositions.join(' - ')}`;
            
            window.open(`https://wa.me/${adminPhone}?text=${encodeURIComponent(msg)}`, '_blank');
            location.reload();

        } catch (e) {
            console.error(e);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
