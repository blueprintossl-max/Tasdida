<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¯ÙŠØ¯Ø© Ù…Ø­ØªØ±Ù | Ø­Ø¬Ø² Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #198754; --dark: #0f172a; --selected: #198754; --booked: #cbd5e1; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f8fafc; margin: 0; padding: 15px; padding-bottom: 100px; text-align: right; }
        .container { max-width: 600px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 30px; }
        .brand-title { font-size: 32px; font-weight: 900; color: var(--dark); margin: 0; }
        .brand-subtitle { color: var(--primary); font-weight: bold; display: block; margin-top: -5px; }

        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #475569; }
        select, input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 15px; outline: none; font-family: inherit; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø³Ø§Ø¹Ø§Øª */
        .time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .time-slot { padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; font-size: 14px; background: #fff; }
        .time-slot.selected { background: var(--selected); color: white; border-color: var(--selected); font-weight: bold; }
        .time-slot.booked { background: var(--booked); color: #94a3b8; cursor: not-allowed; text-decoration: line-through; border-color: #e2e8f0; }
        
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; z-index: 100; }
        .btn-main { background: var(--dark); color: white; border: none; padding: 15px; width: 100%; max-width: 500px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .price-tag { font-weight: bold; color: var(--primary); margin-bottom: 10px; font-size: 18px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 class="brand-title">ØªØ³Ø¯ÙŠØ¯Ø© Ù…Ø­ØªØ±Ù</h1>
        <span class="brand-subtitle">Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ø¹Ø§Ø±Ø¶Ø©</span>
    </header>

    <div class="card">
        <label><i class="fas fa-stadium"></i> Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ø¹Ø¨:</label>
        <select id="stadiumSelect" onchange="loadAvailability()">
            <option value="">-- Ø§Ø®ØªØ± Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ù…Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¹Ø§Ø±Ø¶Ø© --</option>
            <option value="Ù…Ù„Ø¹Ø¨ Ø¨Ù„Ø¯ÙŠØ© Ø§Ù„Ø¹Ø§Ø±Ø¶Ø©" data-price="150">Ù…Ù„Ø¹Ø¨ Ø¨Ù„Ø¯ÙŠØ© Ø§Ù„Ø¹Ø§Ø±Ø¶Ø© (150 Ø±ÙŠØ§Ù„)</option>
            <option value="Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø±ÙˆØ§Ø¯" data-price="140">Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø±ÙˆØ§Ø¯ (140 Ø±ÙŠØ§Ù„)</option>
            <option value="Ù…Ù„Ø¹Ø¨ Ø§Ù„Ù…Ø´Ø§Ù" data-price="130">Ù…Ù„Ø¹Ø¨ Ø§Ù„Ù…Ø´Ø§Ù (130 Ø±ÙŠØ§Ù„)</option>
            <option value="Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø¬ÙˆØ©" data-price="140">Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø¬ÙˆØ© (140 Ø±ÙŠØ§Ù„)</option>
            <option value="Ù…Ù„Ø¹Ø¨ Ù‚Ø§ÙŠÙ… Ø§Ù„Ø¹Ø§Ø±Ø¶Ø©" data-price="120">Ù…Ù„Ø¹Ø¨ Ù‚Ø§ÙŠÙ… Ø§Ù„Ø¹Ø§Ø±Ø¶Ø© (120 Ø±ÙŠØ§Ù„)</option>
        </select>

        <label><i class="fas fa-calendar-alt"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²:</label>
        <input type="date" id="bookDate" onchange="loadAvailability()">

        <label><i class="fas fa-clock"></i> Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ø§Ø¹Ø©):</label>
        <div id="timeGrid" class="time-grid">
            <p style="grid-column: span 3; text-align:center; color:#94a3b8;">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ø¹Ø¨ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹</p>
        </div>
    </div>

    <div class="card">
        <label><i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ†:</label>
        <input type="text" id="capName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
    </div>
</div>

<div class="bottom-bar">
    <div class="price-tag" id="totalDisplay">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Ø±ÙŠØ§Ù„</div>
    <button class="btn-main" onclick="confirmBooking()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ <i class="fab fa-whatsapp"></i></button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ÙƒÙˆØ¯ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
    const firebaseConfig = {
      apiKey: "AIzaSyAfn2LhKnsVGQmoAK_HexN_6bm2-NICNSY",
      authDomain: "tasdida.firebaseapp.com",
      projectId: "tasdida",
      storageBucket: "tasdida.firebasestorage.app",
      messagingSenderId: "72604782215",
      appId: "1:72604782215:web:38a014c331634398d9f222",
      measurementId: "G-KV88C3MP0X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let selectedHours = [];
    let adminPhone = "966500000000"; // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

    // Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    getDoc(doc(db, "settings", "config")).then(s => { if(s.exists()) adminPhone = s.data().adminPhone; });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ² Ù…Ù†Ù‡Ø§
    window.loadAvailability = async function() {
        const stadium = document.getElementById('stadiumSelect').value;
        const date = document.getElementById('bookDate').value;
        const grid = document.getElementById('timeGrid');
        
        if(!stadium || !date) return;

        grid.innerHTML = '<p style="grid-column: span 3; text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙØ±...</p>';
        selectedHours = [];
        updateUI();

        // Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ø¹Ø¨ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
        const q = query(collection(db, "bookings"), where("stadiumName", "==", stadium), where("date", "==", date));
        const snap = await getDocs(q);
        let bookedHours = [];
        snap.forEach(d => { if(d.data().bookedSlots) bookedHours.push(...d.data().bookedSlots); });

        grid.innerHTML = '';
        // ØªÙˆÙ„ÙŠØ¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ (Ù…Ù† 4 Ø¹ØµØ±Ø§Ù‹ Ø¥Ù„Ù‰ 2 ÙØ¬Ø±Ø§Ù‹ ÙƒÙ…Ø«Ø§Ù„)
        for(let h = 16; h <= 26; h++) {
            const displayTime = formatTime(h);
            const slot = document.createElement('div');
            slot.className = 'time-slot';
            
            if(bookedHours.includes(h)) {
                slot.classList.add('booked');
                slot.innerHTML = `${displayTime}<br><small>Ù…Ø­Ø¬ÙˆØ²</small>`;
            } else {
                slot.innerText = displayTime;
                slot.onclick = () => toggleHour(h, slot);
            }
            grid.appendChild(slot);
        }
    }

    function toggleHour(h, el) {
        if(selectedHours.includes(h)) {
            selectedHours = selectedHours.filter(item => item !== h);
            el.classList.remove('selected');
        } else {
            selectedHours.push(h);
            el.classList.add('selected');
        }
        updateUI();
    }

    function updateUI() {
        const select = document.getElementById('stadiumSelect');
        const price = select.options[select.selectedIndex]?.dataset.price || 0;
        document.getElementById('totalDisplay').innerText = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${selectedHours.length * price} Ø±ÙŠØ§Ù„`;
    }

    function formatTime(h) {
        let hour = h % 24;
        let suffix = hour >= 12 ? "Ù…Ø³Ø§Ø¡Ù‹" : "ØµØ¨Ø§Ø­Ø§Ù‹";
        let displayH = hour % 12 || 12;
        return `${displayH}:00 ${suffix}`;
    }

    window.confirmBooking = async function() {
        const name = document.getElementById('capName').value;
        const stadium = document.getElementById('stadiumSelect').value;
        const date = document.getElementById('bookDate').value;
        
        if(!name || !stadium || !date || selectedHours.length === 0) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø®ØªØ± Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");

        const price = document.getElementById('stadiumSelect').options[document.getElementById('stadiumSelect').selectedIndex].dataset.price;
        const total = selectedHours.length * price;

        try {
            await addDoc(collection(db, "bookings"), {
                clientName: name, stadiumName: stadium, date: date,
                bookedSlots: selectedHours, price: total, createdAt: new Date().toISOString()
            });

            const msg = `*Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯ - ØªØ³Ø¯ÙŠØ¯Ø© Ù…Ø­ØªØ±Ù*\nğŸ‘¤ Ø§Ù„ÙƒØ§Ø¨ØªÙ†: ${name}\nğŸŸï¸ Ø§Ù„Ù…Ù„Ø¹Ø¨: ${stadium}\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}\nâ° Ø§Ù„Ø³Ø§Ø¹Ø§Øª: ${selectedHours.map(formatTime).join('ØŒ ')}\nğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø±ÙŠØ§Ù„`;
            window.open(`https://wa.me/${adminPhone}?text=${encodeURIComponent(msg)}`, '_blank');
            location.reload();
        } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ø«Ø§Ù†ÙŠØ©"); }
    }
</script>
</body>
</html>
