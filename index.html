<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ³Ø¯ÙŠØ¯Ø© Ù…Ø­ØªØ±Ù | Pro Striker</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #006847;
            --secondary: #1e293b;
            --accent: #D4AF37;
            --bg: #f8fafc;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--secondary); }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; min-height: 100vh; }

        /* Header */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-top: 10px; }
        .brand h1 { margin: 0; font-size: 24px; font-weight: 900; color: var(--primary); }
        .brand span { color: var(--accent); }
        .user-icon { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); color: var(--primary); }

        /* Hero Grid (Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) */
        .hero-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .hero-card {
            background: white; border-radius: 20px; padding: 20px 10px; text-align: center;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08); cursor: pointer; transition: 0.2s;
            border: 2px solid transparent; height: 140px; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .hero-card:active { transform: scale(0.97); }
        .hero-card i { font-size: 32px; margin-bottom: 10px; }
        
        .card-booking { color: var(--primary); }
        .card-booking.active { background: #f0fdf4; border-color: var(--primary); }
        
        .card-captain { color: #f59e0b; } /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
        .card-captain.active { background: #fffbeb; border-color: #f59e0b; }
        
        .card-player { color: #3b82f6; } /* Ø£Ø²Ø±Ù‚ */
        .card-player.active { background: #eff6ff; border-color: #3b82f6; }

        .hero-card h3 { margin: 0; font-size: 14px; font-weight: 800; }
        .hero-card p { margin: 5px 0 0; font-size: 10px; color: #94a3b8; }

        /* Sections */
        .section { display: none; animation: slideUp 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Forms */
        .form-box { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); }
        label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 8px; color: #64748b; }
        input, select { width: 100%; padding: 14px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 15px; font-family: inherit; outline: none; }
        input:focus, select:focus { border-color: var(--primary); background: white; }

        .btn-main { width: 100%; padding: 15px; border-radius: 14px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-green { background: var(--primary); }
        .btn-orange { background: #f59e0b; }

        /* Match Cards (Requests) */
        .match-card {
            background: white; border-radius: 16px; padding: 15px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
            border-right: 5px solid #3b82f6; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .match-info h4 { margin: 0; font-size: 15px; color: var(--secondary); }
        .match-info p { margin: 5px 0 0; font-size: 12px; color: #64748b; }
        .match-tag { font-size: 11px; background: #eff6ff; color: #3b82f6; padding: 4px 8px; border-radius: 6px; font-weight: bold; display: inline-block; margin-top: 5px; }
        
        .btn-join { background: #3b82f6; color: white; border: none; padding: 8px 15px; border-radius: 10px; font-weight: bold; font-size: 12px; cursor: pointer; }

        /* Time Grid (Booking) */
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; margin-bottom: 15px; }
        .time-slot { padding: 10px; border: 1px solid #e2e8f0; border-radius: 10px; text-align: center; font-size: 12px; cursor: pointer; }
        .time-slot.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .time-slot.booked { background: #f1f5f9; color: #cbd5e1; pointer-events: none; text-decoration: line-through; }

    </style>
</head>
<body>

<div class="container">
    <header class="app-header">
        <div class="brand">
            <h1>ØªØ³Ø¯ÙŠØ¯Ø© <span>Ù…Ø­ØªØ±Ù</span></h1>
            <p>Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ø¹Ø§Ø±Ø¶Ø©</p>
        </div>
        <div class="user-icon"><i class="fas fa-user"></i></div>
    </header>

    <div class="hero-grid">
        <div class="hero-card card-booking" onclick="openSection('bookingSection', this)">
            <i class="far fa-calendar-alt"></i>
            <h3>Ø­Ø¬Ø² Ù…Ù„Ø¹Ø¨</h3>
            <p>Ø§Ø­Ø¬Ø² Ø³Ø§Ø¹ØªÙƒ Ø§Ù„Ø¢Ù†</p>
        </div>
        
        <div class="hero-card card-captain" onclick="openSection('captainRequestSection', this)">
            <i class="fas fa-search"></i>
            <h3>Ø£Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3>
            <p>Ù„Ù„ÙƒØ¨Ø§ØªÙ†: Ø§Ø·Ù„Ø¨ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ</p>
        </div>

        <div class="hero-card card-player" style="grid-column: span 2;" onclick="openSection('playerFindMatchSection', this)">
            <i class="fas fa-futbol"></i>
            <h3>Ø£Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¨Ø§Ø±Ø§Ø©</h3>
            <p>Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: Ø§Ù†Ø¶Ù… Ù„Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</p>
        </div>
    </div>

    <div id="bookingSection" class="section">
        <div class="form-box">
            <h3 style="margin-top:0; color:var(--primary);">ğŸŸï¸ Ø­Ø¬Ø² Ù…Ù„Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
            <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ø¹Ø¨:</label>
            <select id="bStadium" onchange="loadBookingData()"><option value="">-- Ø§Ø®ØªØ± --</option></select>
            
            <div id="bookingDetails" style="display:none;">
                <div style="background:#f0fdf4; color:var(--primary); padding:10px; border-radius:10px; text-align:center; font-weight:bold; margin-bottom:10px;" id="priceDisplay"></div>
                
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²:</label>
                <input type="date" id="bDate" onchange="loadSlots()">
                
                <label>Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:</label>
                <div id="timeGrid" class="time-grid"></div>

                <label>Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ†:</label>
                <input type="text" id="bCapName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">

                <button class="btn-main btn-green" onclick="submitBooking()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² <i class="fas fa-check"></i></button>
            </div>
        </div>
    </div>

    <div id="captainRequestSection" class="section">
        <div class="form-box" style="border-top: 5px solid #f59e0b;">
            <h3 style="margin-top:0; color:#f59e0b;">ğŸ“¢ Ø·Ù„Ø¨ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</h3>
            <p style="font-size:12px; color:#64748b; margin-bottom:20px;">Ø§Ù…Ù„Ø£ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ³ÙŠØ¸Ù‡Ø± Ø·Ù„Ø¨Ùƒ Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙˆØ±Ø§Ù‹.</p>

            <label>Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ†:</label>
            <input type="text" id="reqCapName" placeholder="Ø§Ø³Ù…Ùƒ">

            <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ù„Ù„ØªÙˆØ§ØµÙ„):</label>
            <input type="tel" id="reqPhone" placeholder="05xxxxxxxx">

            <label>ÙÙŠ Ø£ÙŠ Ù…Ù„Ø¹Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©ØŸ</label>
            <select id="reqStadium"><option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ø¹Ø¨ --</option></select>

            <label>Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø°ÙŠ ØªØ­ØªØ§Ø¬Ù‡ (Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬):</label>
            <select id="reqPosition">
                <option value="Ø­Ø§Ø±Ø³">ğŸ§¤ Ø­Ø§Ø±Ø³ Ù…Ø±Ù…Ù‰</option>
                <option value="Ø¯ÙØ§Ø¹">ğŸ›¡ï¸ Ø¯ÙØ§Ø¹</option>
                <option value="ÙˆØ³Ø·">âš™ï¸ ÙˆØ³Ø·</option>
                <option value="Ù‡Ø¬ÙˆÙ…">âš½ Ù‡Ø¬ÙˆÙ…</option>
            </select>

            <label>ÙˆÙ‚Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©:</label>
            <input type="text" id="reqTime" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù„ÙŠÙ„Ø© Ø§Ù„Ø³Ø§Ø¹Ø© 9:00Ù…">

            <button class="btn-main btn-orange" onclick="postCaptainRequest()">Ù†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨ <i class="fas fa-bullhorn"></i></button>
        </div>
    </div>

    <div id="playerFindMatchSection" class="section">
        <h3 style="color:#3b82f6; margin-top:0;">âš½ Ù…Ø¨Ø§Ø±ÙŠØ§Øª ØªØ·Ù„Ø¨ Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3>
        <p style="font-size:12px; color:#64748b; margin-bottom:15px;">Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ¨Ø§ØªÙ†ØŒ Ø§Ø¶ØºØ· "Ù‚Ø¨ÙˆÙ„" Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡Ù….</p>
        
        <div id="matchesList">
            <p style="text-align:center; color:#999; margin-top:30px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§Øª...</p>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ù†ÙØ³ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    const firebaseConfig = {
      apiKey: "AIzaSyAfn2LhKnsVGQmoAK_HexN_6bm2-NICNSY",
      authDomain: "tasdida.firebaseapp.com",
      projectId: "tasdida",
      storageBucket: "tasdida.firebasestorage.app",
      messagingSenderId: "72604782215",
      appId: "1:72604782215:web:38a014c331634398d9f222"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    let stadiumsList = [];
    let selectedSlots = [];
    let adminPhone = "";

    // --- 1. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© (Init) ---
    async function init() {
        const snap = await getDocs(collection(db, "stadiums"));
        const conf = await getDoc(doc(db, "settings", "config"));
        if(conf.exists()) adminPhone = conf.data().adminPhone;

        const bSelect = document.getElementById('bStadium');
        const rSelect = document.getElementById('reqStadium');
        
        bSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ø¹Ø¨ --</option>';
        rSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ø¹Ø¨ --</option>';

        snap.forEach(d => {
            const st = d.data();
            stadiumsList.push({id: d.id, ...st});
            
            // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¬Ø²
            bSelect.innerHTML += `<option value="${d.id}">${st.name}</option>`;
            // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ¨Ø§ØªÙ†
            rSelect.innerHTML += `<option value="${st.name}">${st.name}</option>`;
        });

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ¨Ø§ØªÙ† (Realtime)
        listenToRequests();
    }

    // --- 2. Ø§Ù„ØªÙ†Ù‚Ù„ (Navigation) ---
    window.openSection = (id, el) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.hero-card').forEach(c => c.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(el) el.classList.add('active');
    }

    // --- 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø¬Ø² (Booking) ---
    window.loadBookingData = () => {
        const id = document.getElementById('bStadium').value;
        if(!id) return;
        const st = stadiumsList.find(s => s.id === id);
        document.getElementById('bookingDetails').style.display = 'block';
        document.getElementById('priceDisplay').innerText = `${st.price} Ø±ÙŠØ§Ù„ / Ø³Ø§Ø¹Ø©`;
        window.currentStadium = st;
        loadSlots();
    }

    window.loadSlots = async () => {
        const date = document.getElementById('bDate').value;
        if(!date || !window.currentStadium) return;
        
        const grid = document.getElementById('timeGrid');
        grid.innerHTML = '...';
        selectedSlots = [];

        const q = query(collection(db, "bookings"), where("stadiumName", "==", window.currentStadium.name), where("date", "==", date));
        const snap = await getDocs(q);
        let booked = [];
        snap.forEach(d => { if(d.data().bookedSlots) booked.push(...d.data().bookedSlots); });

        grid.innerHTML = '';
        for(let h=16; h<=26; h++) {
            const div = document.createElement('div');
            div.className = 'time-slot' + (booked.includes(h) ? ' booked' : '');
            div.innerText = (h%12||12) + ':00';
            if(!booked.includes(h)) div.onclick = () => {
                div.classList.toggle('selected');
                selectedSlots.includes(h) ? selectedSlots = selectedSlots.filter(x=>x!==h) : selectedSlots.push(h);
            };
            grid.appendChild(div);
        }
    }

    window.submitBooking = async () => {
        const name = document.getElementById('bCapName').value;
        const date = document.getElementById('bDate').value;
        if(!name || selectedSlots.length === 0) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        
        const total = selectedSlots.length * window.currentStadium.price;
        await addDoc(collection(db, "bookings"), {
            clientName: name, stadiumName: window.currentStadium.name, date,
            bookedSlots: selectedSlots, price: total, status: 'pending', createdAt: new Date().toISOString()
        });
        
        const msg = `Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯\n Ø§Ù„Ù…Ù„Ø¹Ø¨: ${window.currentStadium.name}\n Ø§Ù„ÙƒØ§Ø¨ØªÙ†: ${name}\n Ø§Ù„Ù…Ø¨Ù„Øº: ${total}`;
        window.open(`https://wa.me/${adminPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        location.reload();
    }

    // --- 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙƒØ§Ø¨ØªÙ† (Ù†Ø´Ø± Ø·Ù„Ø¨) ---
    window.postCaptainRequest = async () => {
        const name = document.getElementById('reqCapName').value;
        const phone = document.getElementById('reqPhone').value;
        const stad = document.getElementById('reqStadium').value;
        const pos = document.getElementById('reqPosition').value;
        const time = document.getElementById('reqTime').value;

        if(!name || !phone || !stad) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");

        // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await addDoc(collection(db, "captain_requests"), {
            captainName: name,
            phone: phone,
            stadium: stad,
            position: pos,
            time: time,
            status: "open",
            createdAt: new Date().toISOString()
        });

        alert("âœ… ØªÙ… Ù†Ø´Ø± Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØ±Ø§Ù‡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø§Ù„Ø¢Ù†.");
        location.reload();
    }

    // --- 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø§Ù„Ø¨Ø­Ø« ÙˆÙ‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨) ---
    function listenToRequests() {
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ¨Ø§ØªÙ†
        const q = query(collection(db, "captain_requests"), orderBy("createdAt", "desc"));
        
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('matchesList');
            list.innerHTML = '';
            
            if(snapshot.empty) {
                list.innerHTML = '<p style="text-align:center; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª ØªØ·Ù„Ø¨ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                return;
            }

            snapshot.forEach(doc => {
                const req = doc.data();
                // ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø§Ø¹Ø¨
                list.innerHTML += `
                    <div class="match-card">
                        <div class="match-info">
                            <h4>${req.stadium}</h4>
                            <p><i class="fas fa-user"></i> Ø§Ù„ÙƒØ§Ø¨ØªÙ†: ${req.captainName}</p>
                            <p><i class="far fa-clock"></i> Ø§Ù„ÙˆÙ‚Øª: ${req.time}</p>
                            <span class="match-tag">Ù…Ø·Ù„ÙˆØ¨: ${req.position}</span>
                        </div>
                        <button class="btn-join" onclick="acceptRequest('${req.phone}', '${req.position}', '${req.stadium}')">
                            <i class="fab fa-whatsapp"></i> Ù‚Ø¨ÙˆÙ„
                        </button>
                    </div>
                `;
            });
        });
    }

    // Ø²Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ù„Ù„Ø§Ø¹Ø¨
    window.acceptRequest = (phone, pos, stad) => {
        const msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙƒØ§Ø¨ØªÙ† ğŸ‘‹\nØ±Ø£ÙŠØª Ø·Ù„Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ ØªØ³Ø¯ÙŠØ¯Ø© Ø¨Ø®ØµÙˆØµ Ø®Ø§Ù†Ø© (${pos}) ÙÙŠ (${stad}).\nØ£Ù†Ø§ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø¨!`;
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    init();
</script>
</body>
</html>
