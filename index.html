<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¯ÙŠØ¯Ø© Ù…Ø­ØªØ±Ù | Pro Striker</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --main: #10b981; --dark: #0f172a; --bg: #f8fafc; --glass: rgba(255,255,255,0.95); }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--dark); user-select: none; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; min-height: 100vh; }

        /* Header */
        header { text-align: center; margin-bottom: 20px; }
        .brand { font-size: 28px; font-weight: 900; color: var(--dark); }
        .brand span { color: var(--main); }

        /* Sections */
        .page-section { display: none; animation: fadeIn 0.3s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Stadium Cards */
        .stadium-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 2px solid transparent; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .stadium-card.active { border-color: var(--main); background: #ecfdf5; }
        .price-badge { position: absolute; left: 15px; top: 15px; background: var(--dark); color: white; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; }
        .special-price { background: #e11d48; } /* Ù„ÙˆÙ† Ù„Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª */

        /* Player & Match Cards */
        .player-card, .match-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; border-right: 4px solid var(--main); box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; }
        .pos-tag { padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: bold; background: #e2e8f0; }

        /* Inputs */
        input, select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 10px; font-family: 'Cairo'; box-sizing: border-box; }
        
        /* Time Grid */
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .time-slot { padding: 8px; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; font-size: 12px; cursor: pointer; }
        .time-slot.selected { background: var(--main); color: white; border-color: var(--main); }
        .time-slot.booked { background: #f1f5f9; color: #cbd5e1; pointer-events: none; text-decoration: line-through; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 10px 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); display: flex; justify-content: space-around; z-index: 1000; border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .nav-item { text-align: center; color: #94a3b8; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--main); transform: translateY(-5px); }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }
        .nav-item span { font-size: 10px; font-weight: bold; }

        /* Filter Tabs */
        .filter-tabs { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; }
        .filter-btn { padding: 8px 15px; background: white; border: 1px solid #e2e8f0; border-radius: 20px; cursor: pointer; font-size: 12px; white-space: nowrap; }
        .filter-btn.active { background: var(--main); color: white; border-color: var(--main); }

        .btn-main { width: 100%; padding: 12px; background: var(--main); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-float { position: fixed; bottom: 90px; left: 20px; background: var(--dark); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 999; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand">ØªØ³Ø¯ÙŠØ¯Ø© <span>Ù…Ø­ØªØ±Ù</span></div>
        <div style="font-size:12px; color:#64748b;">Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ø¹Ø§Ø±Ø¶Ø©</div>
    </header>

    <div id="sectionHome" class="page-section active">
        <h3 style="margin-top:0;">ğŸŸï¸ Ø­Ø¬Ø² Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨</h3>
        <div id="stadiumsList"></div>
        
        <div id="bookingForm" style="display:none; background:white; padding:15px; border-radius:15px; margin-top:15px; border:1px solid #e2e8f0;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="margin:0;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²</h4>
                <span id="priceDisplay" style="color:var(--main); font-weight:bold;"></span>
            </div>
            <p id="priceNote" style="font-size:11px; color:#e11d48; display:none;">* Ø³Ø¹Ø± Ø®Ø§Øµ Ù„Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª</p>
            
            <input type="text" id="capName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ†" style="margin-top:10px;">
            <input type="date" id="bookDate" onchange="loadAvailability()">
            <div id="timeGrid" class="time-grid"></div>
            <button class="btn-main" onclick="confirmBooking()" style="margin-top:15px;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² <i class="fab fa-whatsapp"></i></button>
        </div>
    </div>

    <div id="sectionPlayers" class="page-section">
        <h3>ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ Ù„ÙØ±ÙŠÙ‚Ùƒ</h3>
        <div class="filter-tabs">
            <div class="filter-btn active" onclick="filterPlayers('all', this)">Ø§Ù„ÙƒÙ„</div>
            <div class="filter-btn" onclick="filterPlayers('Ø­Ø§Ø±Ø³', this)">ğŸ§¤ Ø­Ø§Ø±Ø³</div>
            <div class="filter-btn" onclick="filterPlayers('Ø¯ÙØ§Ø¹', this)">ğŸ›¡ï¸ Ø¯ÙØ§Ø¹</div>
            <div class="filter-btn" onclick="filterPlayers('ÙˆØ³Ø·', this)">âš™ï¸ ÙˆØ³Ø·</div>
            <div class="filter-btn" onclick="filterPlayers('Ù‡Ø¬ÙˆÙ…', this)">âš½ Ù‡Ø¬ÙˆÙ…</div>
        </div>
        <div id="playersList"></div>
    </div>

    <div id="sectionMatches" class="page-section">
        <h3>ğŸ”¥ Ù…Ø¨Ø§Ø±ÙŠØ§Øª ØªØ¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3>
        <p style="font-size:12px; color:#64748b;">Ù‡Ù†Ø§ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ¨Ø§ØªÙ† Ø§Ù„Ø°ÙŠÙ† ÙŠÙ†Ù‚ØµÙ‡Ù… Ù„Ø§Ø¹Ø¨ÙŠÙ†.</p>
        <div id="matchesList"></div>
        
        <div class="btn-float" onclick="openPlayerRequestModal()"><i class="fas fa-plus"></i></div>
    </div>
</div>

<div id="playerReqModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:white; padding:20px; border-radius:20px; width:80%; max-width:350px;">
        <h3>Ø£Ù†Ø§ Ù„Ø§Ø¹Ø¨ ÙˆØ£Ø¨Ø­Ø« Ø¹Ù† ÙØ±ÙŠÙ‚ ğŸ™‹â€â™‚ï¸</h3>
        <input type="text" id="reqName" placeholder="Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ù„Ù‚Ø¨">
        <input type="text" id="reqPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
        <select id="reqPos">
            <option value="Ø­Ø§Ø±Ø³">ğŸ§¤ Ø­Ø§Ø±Ø³</option>
            <option value="Ø¯ÙØ§Ø¹">ğŸ›¡ï¸ Ø¯ÙØ§Ø¹</option>
            <option value="ÙˆØ³Ø·">âš™ï¸ ÙˆØ³Ø·</option>
            <option value="Ù‡Ø¬ÙˆÙ…">âš½ Ù‡Ø¬ÙˆÙ…</option>
        </select>
        <button class="btn-main" onclick="submitPlayerRequest()">Ù†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨</button>
        <button onclick="document.getElementById('playerReqModal').style.display='none'" style="width:100%; padding:10px; border:none; background:transparent; cursor:pointer; margin-top:5px;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('sectionHome', this)">
        <i class="fas fa-calendar-check"></i>
        <span>Ø­Ø¬Ø² Ù…Ù„Ø¹Ø¨</span>
    </div>
    <div class="nav-item" onclick="switchTab('sectionPlayers', this)">
        <i class="fas fa-users"></i>
        <span>Ù„Ø§Ø¹Ø¨ÙŠÙ†</span>
    </div>
    <div class="nav-item" onclick="switchTab('sectionMatches', this)">
        <i class="fas fa-futbol"></i>
        <span>Ù…Ø¨Ø§Ø±ÙŠØ§Øª</span>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ğŸ”´ ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ğŸ”´
    const firebaseConfig = {
      apiKey: "AIzaSyAfn2LhKnsVGQmoAK_HexN_6bm2-NICNSY",
      authDomain: "tasdida.firebaseapp.com",
      projectId: "tasdida",
      storageBucket: "tasdida.firebasestorage.app",
      messagingSenderId: "72604782215",
      appId: "1:72604782215:web:38a014c331634398d9f222"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    let currentStadium = null;
    let selectedSlots = [];
    let adminPhone = "";
    let adminMobile = ""; // Ù„Ù„Ø¬ÙˆØ§Ù„
    let adminChinese = ""; // Ù„Ù„Ø±Ù‚Ù… Ø§Ù„ØµÙŠÙ†ÙŠ

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø¹Ø¨
    async function init() {
        const conf = await getDoc(doc(db, "settings", "config"));
        if(conf.exists()) {
            adminPhone = conf.data().adminPhone;
            adminMobile = conf.data().adminMobile;
            adminChinese = conf.data().adminChinese;
        }

        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨
        const sSnap = await getDocs(collection(db, "stadiums"));
        const sList = document.getElementById('stadiumsList');
        
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø¹Ø¨ØŒ Ø£Ø¶Ù Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©)
        if(sSnap.empty) {
            sList.innerHTML = "<p style='text-align:center'>Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨...</p>";
            await addDoc(collection(db, "stadiums"), {name:"Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©", basePrice:150, specialPrice:200});
            await addDoc(collection(db, "stadiums"), {name:"Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø±ÙˆØ§Ø¯", basePrice:140, specialPrice:180});
            location.reload(); return;
        }

        sList.innerHTML = '';
        sSnap.forEach(d => {
            const st = d.data();
            const div = document.createElement('div');
            div.className = 'stadium-card';
            div.innerHTML = `
                <div class="price-badge">${st.basePrice} Ø±ÙŠØ§Ù„</div>
                <h4 style="margin:0; font-size:16px;">${st.name}</h4>
                <div style="font-size:12px; color:#64748b;">Ø§Ø¶ØºØ· Ù„Ù„Ø­Ø¬Ø²</div>
            `;
            div.onclick = () => selectStadium(st, div);
            sList.appendChild(div);
        });

        loadPlayers();
        loadMatches();
    }

    function selectStadium(st, el) {
        currentStadium = st;
        document.querySelectorAll('.stadium-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('bookingForm').style.display = 'block';
        loadAvailability();
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø±Ù†Ø© (Ø¹Ø§Ø¯ÙŠ / Ù…Ù†Ø§Ø³Ø¨Ø§Øª)
    window.loadAvailability = async function() {
        const dateVal = document.getElementById('bookDate').value;
        const grid = document.getElementById('timeGrid');
        if(!dateVal || !currentStadium) return;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ù‡Ùˆ ÙŠÙˆÙ… Ø¬Ù…Ø¹Ø© (Ù…Ø«Ù„Ø§Ù‹) Ø£Ùˆ ÙŠÙˆÙ… Ø­Ø¯Ø¯Ù‡ Ø§Ù„Ø£Ø¯Ù…Ù† ÙƒÙ…Ù†Ø§Ø³Ø¨Ø©ØŸ
        // Ù„Ù„ØªØ¨Ø³ÙŠØ·: Ø³Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ø®Ù…ÙŠØ³ ÙˆØ§Ù„Ø¬Ù…Ø¹Ø© Ø£ÙŠØ§Ù… Ù…Ù†Ø§Ø³Ø¨Ø§Øª
        const day = new Date(dateVal).getDay();
        const isSpecial = (day === 4 || day === 5); // 4=Ø§Ù„Ø®Ù…ÙŠØ³, 5=Ø§Ù„Ø¬Ù…Ø¹Ø©
        
        const finalPrice = isSpecial ? (currentStadium.specialPrice || currentStadium.basePrice) : currentStadium.basePrice;
        
        document.getElementById('priceDisplay').innerText = `${finalPrice} Ø±ÙŠØ§Ù„/Ø³Ø§Ø¹Ø©`;
        document.getElementById('priceNote').style.display = isSpecial ? 'block' : 'none';
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
        selectedSlots = [];
        const q = query(collection(db, "bookings"), where("stadiumName", "==", currentStadium.name), where("date", "==", dateVal));
        const snap = await getDocs(q);
        let booked = [];
        snap.forEach(d => booked.push(...(d.data().bookedSlots || [])));

        grid.innerHTML = '';
        for(let h=16; h<=26; h++) {
            const d = document.createElement('div');
            d.className = 'time-slot' + (booked.includes(h) ? ' booked' : '');
            d.innerText = (h%12||12) + ':00';
            if(!booked.includes(h)) d.onclick = () => {
                d.classList.toggle('selected');
                selectedSlots.includes(h) ? selectedSlots = selectedSlots.filter(x=>x!==h) : selectedSlots.push(h);
            };
            grid.appendChild(d);
        }
    }

    window.confirmBooking = async function() {
        const name = document.getElementById('capName').value;
        const date = document.getElementById('bookDate').value;
        if(!name || selectedSlots.length===0) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        const isSpecial = document.getElementById('priceNote').style.display === 'block';
        const unitPrice = isSpecial ? (currentStadium.specialPrice || currentStadium.basePrice) : currentStadium.basePrice;
        const total = selectedSlots.length * unitPrice;

        await addDoc(collection(db, "bookings"), {
            clientName: name, stadiumName: currentStadium.name, date, bookedSlots: selectedSlots,
            price: total, createdAt: new Date().toISOString(), needsPlayers: false // ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„Ù‡Ø§
        });

        const msg = `Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯\nğŸŸï¸ ${currentStadium.name}\nğŸ‘¤ ${name}\nğŸ’° ${total} Ø±ÙŠØ§Ù„`;
        window.open(`https://wa.me/${adminPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        location.reload();
    }

    // --- Ù‚Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ---
    async function loadPlayers() {
        onSnapshot(collection(db, "player_requests"), (snap) => {
            const list = document.getElementById('playersList');
            list.innerHTML = '';
            snap.forEach(d => {
                const p = d.data();
                list.innerHTML += `
                    <div class="player-card" data-pos="${p.pos}">
                        <div>
                            <div style="font-weight:bold;">${p.name}</div>
                            <div style="font-size:12px; color:#64748b;">${p.phone}</div>
                        </div>
                        <span class="pos-tag">${p.pos}</span>
                    </div>`;
            });
        });
    }
    
    window.filterPlayers = function(pos, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.player-card').forEach(c => {
            c.style.display = (pos === 'all' || c.dataset.pos === pos) ? 'flex' : 'none';
        });
    }

    // --- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… ---
    async function loadMatches() {
        const q = query(collection(db, "bookings"), where("needsPlayers", "==", true)); // ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø² Ù„ÙŠÙ‚Ø¨Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„
        // Ù‡Ù†Ø§ Ø³Ù†Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯ ÙƒÙ…Ø«Ø§Ù„
    }

    window.openPlayerRequestModal = () => document.getElementById('playerReqModal').style.display = 'flex';
    
    window.submitPlayerRequest = async function() {
        const name = document.getElementById('reqName').value;
        const phone = document.getElementById('reqPhone').value;
        const pos = document.getElementById('reqPos').value;
        if(!name || !phone) return;
        
        await addDoc(collection(db, "player_requests"), { name, phone, pos, createdAt: new Date() });
        alert("ØªÙ… Ù†Ø´Ø± Ø·Ù„Ø¨ÙƒØŒ Ø³ÙŠØ±Ø§Ùƒ Ø§Ù„ÙƒØ¨Ø§ØªÙ† Ø§Ù„Ø¢Ù†! âœ…");
        location.reload();
    }

    // Ø§Ù„ØªÙ†Ù‚Ù„
    window.switchTab = function(sectId, el) {
        document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
        document.getElementById(sectId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    init();
</script>
</body>
</html>
